#!/bin/bash
# shellcheck disable=SC1090,SC1091

set -x
set -e
set -u

declare -gx branch=dev

# Any option such as -c that isn't processed is here just to satisfy CI/CD
# stuff which passes some default arguments (like -c for cluster).
while getopts ":" opt; do
  case ${opt} in
    b)
      branch="${OPTARG}"
    ;;
    *)
      true
    ;;
  esac
done

if [ "${branch}" != 'dev' ] && [ "${branch}" != 'production' ]; then
  exit 0
fi

yarn install

rm -rf amplify-backup

IFS='|'

AWSCLOUDFORMATIONCONFIG="{\
\"configLevel\":\"project\",\
\"useProfile\":false,\
\"accessKeyId\":\"$AWS_ACCESS_KEY_ID\",\
\"secretAccessKey\":\"$AWS_SECRET_ACCESS_KEY\",\
\"region\":\"us-east-1\"\
}"

AMPLIFY="{\
\"envName\":\"$branch\",\
\"defaultEditor\":\"code\"\
}"

PROVIDERS="{\
\"awscloudformation\":$AWSCLOUDFORMATIONCONFIG\
}"

yarn build

# Run amplify start-deployment of the dist directory
amplify start-deployment --src ./dist

# Output contents of dist/downloads/pdf directory
if [ -d "./dist/downloads/pdf" ]; then
  echo "Contents of dist/downloads/pdf directory:"
  ls -l ./dist/downloads/pdf
else
  echo "Directory dist/downloads/pdf does not exist."
fi


